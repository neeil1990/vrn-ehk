(function(){"use strict";BX.namespace("BX.Landing");var a=BX.Landing.Utils.isPlainObject;var n=BX.Landing.Utils.isString;var t=BX.Landing.Utils.addQueryParams;BX.Landing.Backend=function(){this.ajaxController=t("/bitrix/tools/landing/ajax.php",{site:BX.message["SITE_ID"]?BX.message("SITE_ID"):undefined})};BX.Landing.Backend.instance=null;BX.Landing.Backend.getInstance=function(){if(!BX.Landing.Backend.instance){BX.Landing.Backend.instance=new BX.Landing.Backend}return BX.Landing.Backend.instance};BX.Landing.Backend.prototype={action:function(a,t,i,e){e=BX.type.isPlainObject(e)?e:{};i=BX.type.isPlainObject(i)?i:{};if(this.getSiteId()!==undefined){BX.Landing.Utils.assign(i,{site_id:this.getSiteId()})}var d={};d.sessid=BX.bitrix_sessid();d.action=a.replace("Landing\\Block","Block");d.data=typeof t==="object"?t:{};d.data.lid=d.data.lid||BX.Landing.Main.getInstance().id;if("action"in e){d.action=e.action}if("block"in e){d.data.block=e.block}if("lid"in e){d.data.lid=e.lid}if("id"in e){d.data.id=e.id}var o=BX.util.add_url_param(this.ajaxController,BX.util.objectMerge({action:d.action},i));return new Promise(function(a,n){BX.ajax({method:"POST",dataType:"json",url:o,data:d,onsuccess:function(t){if(!!t&&t.type==="error"){n(t)}else{a(t.result)}},onfailure:function(a){n(a)}})}).then(function(a){if(d.action==="Block::updateNodes"||d.action==="Block::removeCard"||d.action==="Block::cloneCard"||d.action==="Block::addCard"||d.action==="Block::updateStyles"){BX.Landing.UI.Panel.StatusPanel.getInstance().update()}return a}).catch(function(a){if(d.action!=="Block::getById"){a=n(a)?{type:"error"}:a;a.action=d.action;BX.Landing.ErrorManager.getInstance().add(a)}return Promise.reject()})},batch:function(a,t,i){i=BX.type.isPlainObject(i)?i:{};BX.Landing.Utils.assign(i,{site_id:t.siteId||this.getSiteId()});var e={};e.sessid=BX.bitrix_sessid();e.action=a.replace("Landing\\Block","Block");e.data={};e.batch=typeof t==="object"?t:{};e.data.lid=e.data.lid||BX.Landing.Main.getInstance().id;var d=BX.util.add_url_param(this.ajaxController,BX.util.objectMerge({action:e.action},i));return new Promise(function(a,n){BX.ajax({method:"POST",dataType:"json",url:d,data:e,onsuccess:function(t){if(!!t&&t.type==="error"){n(t)}else{a(t)}},onfailure:function(a){n(a)}})}).then(function(a){BX.Landing.UI.Panel.StatusPanel.getInstance().update();return a}).catch(function(a){if(e.action!=="Block::getById"){a=n(a)?{type:"error"}:a;a.action=e.action;BX.Landing.ErrorManager.getInstance().add(a)}return Promise.reject()})},getSiteId:function(){var a;try{a=BX.Landing.Main.getInstance().options.site_id}catch(n){a=-1}return a},upload:function(a,t){var i=new FormData;var e=t||{};var d="Block::uploadFile";i.append("sessid",BX.bitrix_sessid());i.append("action","Block::uploadFile");i.append("picture",a,a.name);if("block"in e){i.append("data[block]",e.block)}if("lid"in e){d="Landing::uploadFile";i.append("data[lid]",e.lid);i.set("action",d)}if("id"in e){d="Site::uploadFile";i.append("data[id]",e.id);i.set("action",d)}var o=BX.util.add_url_param(this.ajaxController,{action:d,site_id:this.getSiteId()});if(e.context){o=BX.util.add_url_param(o,{context:e.context})}return new Promise(function(a,n){var t=BX.ajax({url:o,method:"POST",dataType:"json",data:i,start:false,preparePost:false,onsuccess:function(t){if(!!t&&t.type==="error"){n(t)}else{a(t.result)}},onfailure:function(a){n(a)}});t.send(i)}).catch(function(a){a=n(a)?{type:"error"}:a;a.action="Block::uploadFile";BX.Landing.ErrorManager.getInstance().add(a);return Promise.reject(a)})},uploadImage:function(t,i,e,d){if(!t){t=document.createElement("form")}d=a(d)?d:{};var o={};o.sessid=BX.bitrix_sessid();o.action="action"in d?d.action:"Utils::uploadFile";o.picture=i;o.data={};o.data.params=typeof e==="object"?e:{};if("block"in d){o.data.block=d.block}if("lid"in d){o.data.lid=d.lid}if("id"in d){o.data.id=d.id}var r=BX.util.add_url_param(this.ajaxController,{action:o.action,site_id:this.getSiteId()});return new Promise(function(a,n){BX.ajax.submitAjax(t,{url:r,method:"POST",dataType:"json",data:o,onsuccess:function(t){if(!!t&&t.type==="error"){n(t)}else{a(t.result)}},onfailure:function(a){n(a)}})}).catch(function(a){a=n(a)?{type:"error"}:a;a.action=o.action;BX.Landing.ErrorManager.getInstance().add(a);return Promise.reject()})}}})();
//# sourceMappingURL=backend.map.js